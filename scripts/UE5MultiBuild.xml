<?xml version='1.0' ?>
<BuildGraph xmlns="http://www.epicgames.com/BuildGraph" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.epicgames.com/BuildGraph ./Schema.xsd" >

    <!-- Environment options -->
    <Option Name="EnginePath" Restrict=".*" DefaultValue="" Description="Path to the engine" />
    <Option Name="TempPath" Restrict=".*" DefaultValue="" Description="Path to the temp folder" />
    <!--<Option Name="ProjectPath" Restrict=".*" DefaultValue="" Description="Path to the .uproject" />
    <Option Name="ProjectRoot" Restrict=".*" DefaultValue="" Description="Path to project directory" />-->
    <Option Name="ProjectsFolder" Restrict=".*" DefaultValue="%userprofile%\Documents\UnrealProjects" Description="Path to folder containing projects" />
    
    <!-- Project options-->
    <Option Name="Projects" Restrict="[^ ]+" DefaultValue="BuildGraphTest" Description="Projects to Build, Cook, Stage, And Package, along with all project specific configurations in the format: ProjectName*EditorTarget*GameTargets*ClientTargets*ServerTargets*GamePlatforms*ClientPlatforms*ServerPlatforms*GameConfigurations*ClientConfigurations*ServerConfigurations*StrictIncludes*BuildVersion*ExecuteTests*TestsToRun*ExecuteDeploy*DeployTo+ProjectName*EditorTarget*GameTargets*ClientTargets*ServerTargets*GamePlatforms*ClientPlatforms*ServerPlatforms*GameConfigurations*ClientConfigurations*ServerConfigurations*StrictIncludes*BuildVersion*ExecuteTests*TestsToRun*ExecuteDeploy*DeployTo" />

    <!-- Build options -->
    <Option Name="ExecuteBuild" Restrict="true|false" DefaultValue="true" Description="Execute the build steps" />

    <!-- 
    <Option Name="EditorTarget" Restrict="[^ ]+" DefaultValue="UnrealEditor" Description="Name of Editor target to build, separated by + per project" />

    <Option Name="GameTargets" Restrict="[^ ]*" DefaultValue="$(Projects)" Description="List of Game targets to build, e.g. UnrealGame or {ProjectName}, separated by semicolons" />
    <Option Name="ClientTargets" Restrict="[^ ]*" DefaultValue="" Description="List of Client targets to build, e.g. UnrealClient or {ProjectNameClient}, separated by semicolons" />
    <Option Name="ServerTargets" Restrict="[^ ]*" DefaultValue="" Description="List of Server targets to build, e.g. UnrealServer or {ProjectNameServer}, separated by semicolons" />

    <Option Name="GameTargetPlatforms" Restrict="[^ ]*" DefaultValue="Win64" Description="Target platforms for the game build, separated by semicolons, e.g. Win64;Linux;PS5" />
    <Option Name="ClientTargetPlatforms" Restrict="[^ ]*" DefaultValue="Win64" Description="Target platforms for the client build, separated by semicolons, e.g. Win64;Linux;PS5" />
    <Option Name="ServerTargetPlatforms" Restrict="[^ ]*" DefaultValue="Win64" Description="Target platforms for the server build, separated by semicolons, e.g. Win64;Linux;MacOS" />

    <Option Name="GameConfigurations" Restrict="[^ ]*" DefaultValue="Development" Description="Configurations for the game build, separated by semicolons, e.g. Development;Shipping" />
    <Option Name="ClientConfigurations" Restrict="[^ ]*" DefaultValue="Development" Description="Configurations for the client build, separated by semicolons, e.g. Development;Shipping" />
    <Option Name="ServerConfigurations" Restrict="[^ ]*" DefaultValue="Development" Description="Configurations for the server build, separated by semicolons, e.g. Development;Shipping" />
    -->

    <Option Name="MacPlatforms" Restrict="[^ ]*" DefaultValue="Mac;IOS" Description="List of Platforms to be built on Mac agents, separated by semicolons, e.g. Mac;IOS" />
    <!--
    <Option Name="StrictIncludes" Restrict="true|false" DefaultValue="false" Description="Include What You Use" />
    -->

    <!-- Metadata -->
    <Option Name="BuildVersion" Restrict="[^ ]*" DefaultValue="" Description="Version string to use for the build" />

    <!-- Stage options -->
    <Option Name="StageDirectory" Restrict=".+" DefaultValue="$(ProjectsFolder)\StagedBuilds" Description="Path to the staging directory" />

    <!-- Archive options-->
    <Option Name="ExecuteArchive" Restrict="true|false" DefaultValue="false" Description="Execute the archive steps" />
    <Option Name="ArchivePath" Restrict=".+" DefaultValue="$(ProjectsFolder)\ArchivedBuilds" Description="Path to the archive directory" />

    <!--
    <!- Test options ->
    <Option Name="ExecuteTests" Restrict="true|false" DefaultValue="false" Description="Execute the test steps" />
    <Option Name="TestsToRun" Restrict="[^ ]*" DefaultValue="" Description="Tests to run, separated by semicolons, e.g. SmokeTests;PerfTests" />
    

    <!- Deployment options ->
    <Option Name="ExecuteDeploy" Restrict="true|false" DefaultValue="false" Description="Execute the deploy steps" />
    <Option Name="DeployTo" Restrict="[^ ]*" DefaultValue="" Description="Platforms to deploy to, separated by semicolons, e.g. Steam;GoogleDrive" />
    -->

    <Property Name="GameBinaries" Value="" />
    <Property Name="ClientBinaries" Value="" />
    <Property Name="ServerBinaries" Value="" />

    <Property Name="GameCookedContent" Value="" />
    <Property Name="ClientCookedContent" Value="" />
    <Property Name="ServerCookedContent" Value="" />

    <Property Name="GameStagedContent" Value="" />
    <Property Name="ClientStagedContent" Value="" />
    <Property Name="ServerStagedContent" Value="" />

    <!--========End of Config Global Config========-->
    <ForEach Name="ProjectConfig" Values="$(Projects)" Separator="+">
    
    <Property Name="ProjectName" Value="" />
    <Property Name="EditorTarget" Value="" />
    <Property Name="GameTargets" Value="" />
    <Property Name="ClientTargets" Value="" />
    <Property Name="ServerTargets" Value="" />
    <Property Name="GameTargetPlatforms" Value="" />
    <Property Name="ClientTargetPlatforms" Value="" />
    <Property Name="ServerTargetPlatforms" Value="" />
    <Property Name="GameConfigurations" Value="" />
    <Property Name="ClientConfigurations" Value="" />
    <Property Name="ServerConfigurations" Value="" />
    <Property Name="StrictIncludes" Value="" />
    <Property Name="BuildVersion" Value="" />
    <Property Name="ExecuteTests" Value="" />
    <Property Name="TestsToRun" Value="" />
    <Property Name="ExecuteDeploy" Value="" />
    <Property Name="DeployTo" Value="" />
    <ForEach Name="ConfigValues" Values="$(ProjectConfig)" Separator="*">
        <Switch>
            <Case If="'$(ProjectName)' == ''">
                <Property Name="ProjectName" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(EditorTarget)' == ''">
                <Property Name="EditorTarget" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(GameTargets)' == ''">
                <Property Name="GameTargets" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(ClientTargets)' == ''">
                <Property Name="ClientTargets" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(ServerTargets)' == ''">
                <Property Name="ServerTargets" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(GameTargetPlatforms)' == ''">
                <Property Name="GameTargetPlatforms" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(ClientTargetPlatforms)' == ''">
                <Property Name="ClientTargetPlatforms" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(ServerTargetPlatforms)' == ''">
                <Property Name="ServerTargetPlatforms" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(GameConfigurations)' == ''">
                <Property Name="GameConfigurations" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(ClientConfigurations)' == ''">
                <Property Name="ClientConfigurations" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(ServerConfigurations)' == ''">
                <Property Name="ServerConfigurations" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(StrictIncludes)' == ''">
                <Property Name="StrictIncludes" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(BuildVersion)' == ''">
                <Property Name="BuildVersion" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(ExecuteTests)' == ''">
                <Property Name="ExecuteTests" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(TestsToRun)' == ''">
                <Property Name="TestsToRun" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(ExecuteDeploy)' == ''">
                <Property Name="ExecuteDeploy" Value="$(ConfigValues)" />
            </Case>
            <Case If="'$(DeployTo)' == ''">
                <Property Name="DeployTo" Value="$(ConfigValues)" />
            </Case>
        </Switch>
    </ForEach>
    <ForEach Name="Property" Values="ProjectName;EditorTarget;GameTargets;ClientTargets;ServerTargets;GameTargetPlatforms;ClientTargetPlatforms;ServerTargetPlatforms;GameConfigurations;ClientConfigurations;ServerConfigurations;StrictIncludes;BuildVersion;ExecuteTests;TestsToRun;ExecuteDeploy;DeployTo">
        <Property Name="$(Property)" Value="" If="'$($(Property))' == '_'" />
    </ForEach>

    <Property Name="ProjectPath" Value="$(ProjectsFolder)\$(ProjectName)\$(ProjectName).uproject" />
    <Property Name="ProjectRoot" Value="$(ProjectsFolder)\$(ProjectName)" />

    <Property Name="Tests" Value="" />

    <Property Name="Deployments" Value="" />

    <Property Name="AdditionalArguments" Value="" If="'$(StrictIncludes)' == 'false'" />
    <Property Name="AdditionalArguments" Value=" -iwyu -NoPCH -NoSharedPCH -DisableUnity" If="'$(StrictIncludes)' == 'true'" />

    <!-- Targets that will be executed on a Windows machine-->
    <Agent Name="Windows Build" Type="Win64" If="'$(ExecuteBuild)' == 'true'">

        <!-- Compile the editor for Windows (required for later cook)-->
            <Property Name="ProjectPath" Value="$(ProjectsFolder)\$(ProjectName)\$(ProjectName).uproject" />
            <Node Name="Compile $(EditorTarget) Win64 for $(ProjectName)" Produces="#EditorBinaries_$(ProjectName)">
                <Compile Target="$(EditorTarget)" Platform="Win64" Configuration="Development" Tag="#EditorBinaries_$(ProjectName)" Arguments="-Project=&quot;$(ProjectPath)&quot; $(AdditionalArguments)" AllowParallelExecutor="false" />
            </Node>

        <!-- Compile the Game-->
            <ForEach Name="TargetName" Values="$(GameTargets)">
                <ForEach Name="TargetPlatform" Values="$(GameTargetPlatforms)">
                    <ForEach Name="TargetConfiguration" Values="$(GameConfigurations)">
                        <Node Name="Compile $(ProjectName) $(TargetName) $(TargetPlatform) $(TargetConfiguration)" Produces="#GameBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="!ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')">
                            <Compile Target="$(TargetName)" Platform="$(TargetPlatform)" Configuration="$(TargetConfiguration)" Tag="#GameBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" Arguments="-Project=&quot;$(ProjectPath)&quot; $(AdditionalArguments)" />
                            <Tag Files="#GameBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" Filter="*.target" With="#GameReceipts_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                            <SanitizeReceipt Files="#GameReceipts_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                        </Node>
                        <Property Name="GameBinaries" Value="$(GameBinaries)#GameBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);" />
                    </ForEach>
                </ForEach>
            </ForEach>

        <!-- Compile the Client-->
            <ForEach Name="TargetName" Values="$(ClientTargets)">
                <ForEach Name="TargetPlatform" Values="$(ClientTargetPlatforms)">
                    <ForEach Name="TargetConfiguration" Values="$(ClientConfigurations)">
                        <Node Name="Compile $(ProjectName) $(TargetName) $(TargetPlatform) $(TargetConfiguration)" Produces="#ClientBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="!ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')">
                            <Compile Target="$(TargetName)" Platform="$(TargetPlatform)" Configuration="$(TargetConfiguration)" Tag="#ClientBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" Arguments="-Project=&quot;$(ProjectPath)&quot; $(AdditionalArguments)" />
                            <Tag Files="#ClientBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" Filter="*.target" With="#ClientReceipts_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                            <SanitizeReceipt Files="#ClientReceipts_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                        </Node>
                        <Property Name="ClientBinaries" Value="$(ClientBinaries)#ClientBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);" />
                    </ForEach>
                </ForEach>
            </ForEach>

        <!-- Compile the Dedicated Server-->
            <ForEach Name="TargetName" Values="$(ServerTargets)">
                <ForEach Name="TargetPlatform" Values="$(ServerTargetPlatforms)">
                    <ForEach Name="TargetConfiguration" Values="$(ServerConfigurations)">
                        <Node Name="Compile $(ProjectName) $(TargetName) $(TargetPlatform) $(TargetConfiguration)" Produces="#ServerBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="!ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')">
                            <Compile Target="$(TargetName)" Platform="$(TargetPlatform)" Configuration="$(TargetConfiguration)" Tag="#ServerBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" Arguments="-Project=&quot;$(ProjectPath)&quot; $(AdditionalArguments)" />
                            <Tag Files="#ServerBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" Filter="*.target" With="#ServerReceipts_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                            <SanitizeReceipt Files="#ServerReceipts_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                        </Node>
                        <Property Name="ServerBinaries" Value="$(ServerBinaries)#ServerBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);" />
                    </ForEach>
                </ForEach>
            </ForEach>

    </Agent>

    <!-- Targets that will be executed on a Mac machine-->
    <Agent Name="MacOS Build" Type="Mac" If="'$(ExecuteBuild)' == 'true'">

        <!-- Compile the Game-->
            <ForEach Name="TargetName" Values="$(GameTargets)">
                <ForEach Name="TargetPlatform" Values="$(GameTargetPlatforms)">
                    <ForEach Name="TargetConfiguration" Values="$(GameConfigurations)">
                        <Node Name="Compile $(ProjectName) $(TargetName) $(TargetPlatform) $(TargetConfiguration)" Produces="#GameBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')">
                            <Compile Target="$(TargetName)" Platform="$(TargetPlatform)" Configuration="$(TargetConfiguration)" Tag="#GameBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" Arguments="-Project=&quot;$(ProjectPath)&quot; $(AdditionalArguments)" />
                            <Tag Files="#GameBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" Filter="*.target" With="#GameReceipts_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                            <SanitizeReceipt Files="#GameReceipts_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                        </Node>
                        <Property Name="GameBinaries" Value="$(GameBinaries)#GameBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);" />
                    </ForEach>
                </ForEach>
            </ForEach>

        <!-- Compile the Client-->
            <ForEach Name="TargetName" Values="$(ClientTargets)">
                <ForEach Name="TargetPlatform" Values="$(ClientTargetPlatforms)">
                    <ForEach Name="TargetConfiguration" Values="$(ClientConfigurations)">
                        <Node Name="Compile $(ProjectName) $(TargetName) $(TargetPlatform) $(TargetConfiguration)" Produces="#ClientBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')">
                            <Compile Target="$(TargetName)" Platform="$(TargetPlatform)" Configuration="$(TargetConfiguration)" Tag="#ClientBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" Arguments="-Project=&quot;$(ProjectPath)&quot; $(AdditionalArguments)" />
                            <Tag Files="#ClientBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" Filter="*.target" With="#ClientReceipts_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                            <SanitizeReceipt Files="#ClientReceipts_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                        </Node>
                        <Property Name="ClientBinaries" Value="$(ClientBinaries)#ClientBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);" />
                    </ForEach>
                </ForEach>
            </ForEach>

        <!-- Compile the Dedicated Server-->
            <ForEach Name="TargetName" Values="$(ServerTargets)">
                <ForEach Name="TargetPlatform" Values="$(ServerTargetPlatforms)">
                    <ForEach Name="TargetConfiguration" Values="$(ServerConfigurations)">
                        <Node Name="Compile $(ProjectName) $(TargetName) $(TargetPlatform) $(TargetConfiguration)" Produces="#ServerBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')">
                            <Compile Target="$(TargetName)" Platform="$(TargetPlatform)" Configuration="$(TargetConfiguration)" Tag="#ServerBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" Arguments="-Project=&quot;$(ProjectPath)&quot; $(AdditionalArguments)" />
                            <Tag Files="#ServerBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" Filter="*.target" With="#ServerReceipts_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                            <SanitizeReceipt Files="#ServerReceipts_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                        </Node>
                        <Property Name="ServerBinaries" Value="$(ServerBinaries)#ServerBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);" />
                    </ForEach>
                </ForEach>
            </ForEach>

        <!-- No cooking on MacOS-->

    </Agent>

    <!-- Targets that will be executed on a Linux machine-->
    <Agent Name="Linux" Type="Linux" If="'$(ExecuteBuild)' == 'true'">
        
        <!-- Nothing here yet...-->

    </Agent>

    <!-- Targets that will be executed on a Windows machine-->
    <Agent Name="Windows Cook" Type="Win64" If="'$(ExecuteBuild)' == 'true'">

        <!-- Cook for Game platforms-->
            <ForEach Name="TargetPlatform" Values="$(GameTargetPlatforms)">
                <Node Name="Cook Game $(ProjectName) $(TargetPlatform)" Requires="#EditorBinaries_$(ProjectName)" Produces="#GameCookedContent_$(ProjectName)_$(TargetPlatform)">
                    <Property Name="CookPlatform" Value="$(TargetPlatform)" />
                    <Property Name="CookPlatform" Value="Windows" If="'$(CookPlatform)' == 'Win64'" />
                    <Cook Project="$(ProjectPath)" Platform="$(CookPlatform)" Tag="#GameCookedContent_$(ProjectName)_$(TargetPlatform)" />
                </Node>
                <Property Name="GameCookedContent" Value="$(GameCookedContent)#GameCookedContent_$(ProjectName)_$(TargetPlatform);" />
            </ForEach>

        <!-- Cook for Client platforms-->
            <ForEach Name="TargetName" Values="$(ClientTargets)">
                <ForEach Name="TargetPlatform" Values="$(ClientTargetPlatforms)">
                    <Node Name="Cook Client $(ProjectName) $(TargetPlatform)" Requires="#EditorBinaries_$(ProjectName)" Produces="#ClientCookedContent_$(ProjectName)_$(TargetPlatform)">
                        <Property Name="CookPlatform" Value="$(TargetPlatform)" />
                        <Property Name="CookPlatform" Value="Windows" If="'$(CookPlatform)' == 'Win64'" />
                        <Property Name="CookPlatform" Value="$(CookPlatform)Client" If="('$(CookPlatform)' == 'Windows') or ('$(CookPlatform)' == 'Mac') or ('$(CookPlatform)' == 'Linux')" />
                        <Cook Project="$(ProjectPath)" Platform="$(CookPlatform)" Tag="#ClientCookedContent_$(ProjectName)_$(TargetPlatform)" />
                    </Node>
                    <Property Name="ClientCookedContent" Value="$(ClientCookedContent)#ClientCookedContent_$(ProjectName)_$(TargetPlatform);" />
                </ForEach>
            </ForEach>

        <!-- Cook for Dedicated Servers-->
            <ForEach Name="TargetName" Values="$(ServerTargets)">
                <ForEach Name="TargetPlatform" Values="$(ServerTargetPlatforms)">
                    <Node Name="Cook Server $(ProjectName) $(TargetPlatform)" Requires="#EditorBinaries_$(ProjectName)" Produces="#ServerCookedContent_$(ProjectName)_$(TargetPlatform)">
                        <Property Name="CookPlatform" Value="$(TargetPlatform)" />
                        <Property Name="CookPlatform" Value="Windows" If="'$(CookPlatform)' == 'Win64'" />
                        <Property Name="CookPlatform" Value="$(CookPlatform)Server" If="('$(CookPlatform)' == 'Windows') or ('$(CookPlatform)' == 'Mac') or ('$(CookPlatform)' == 'Linux')" />
                        <Cook Project="$(ProjectPath)" Platform="$(CookPlatform)" Tag="#ServerCookedContent_$(ProjectName)_$(TargetPlatform)" />
                    </Node>
                    <Property Name="ServerCookedContent" Value="$(ServerCookedContent)#ServerCookedContent_$(ProjectName)_$(TargetPlatform);" />
                </ForEach>
            </ForEach>

    </Agent>

    <!-- Targets that will be executed on a Windows machine-->
    <Agent Name="Windows Stage and Package" Type="Win64" If="'$(ExecuteBuild)' == 'true'">

        <!-- Stage and Package the Game-->
            <ForEach Name="TargetName" Values="$(GameTargets)">
                <ForEach Name="TargetPlatform" Values="$(GameTargetPlatforms)">
                    <ForEach Name="TargetConfiguration" Values="$(GameConfigurations)">
                        <Node Name="Stage and Package $(ProjectName) $(TargetName) $(TargetPlatform) $(TargetConfiguration)" Requires="#GameBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);#GameCookedContent_$(ProjectName)_$(TargetPlatform)" Produces="#GameStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="!ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')">
                            <Property Name="StagePlatform" Value="$(TargetPlatform)" />
                            <Property Name="StagePlatform" Value="Windows" If="'$(StagePlatform)' == 'Win64'" />
                            <Property Name="DisableCodeSigning" Value="" />
                            <Property Name="DisableCodeSigning" Value="-NoCodeSign" If="('$(TargetPlatform)' == 'Win64') or ('$(TargetPlatform)' == 'Mac') or ('$(TargetPlatform)' == 'Linux')" />
                            <Property Name="ArchivalFlag" Value="" />
                            <Property Name="ArchivalFlag" Value="-Archive -Archivedirectory=&quot;$(ArchivePath)\$(ProjectName)&quot;" If="'$(ExecuteArchive)' == 'true'" />
                            <Property Name="PackageFlag" Value="" />
                            <Property Name="PackageFlag" Value="-package" If="('$(TargetPlatform)' == 'IOS') or ('$(TargetPlatform)' == 'Android')" />
                            <Spawn Exe="cmd" Arguments="/C set &quot;uebp_UATMutexNoWait=1&quot; &amp; set &amp; $(EnginePath)\Build\BatchFiles\RunUAT.bat BuildCookRun -project=&quot;$(ProjectPath)&quot; -noP4 $(DisableCodeSigning) -platform=$(TargetPlatform) -clientconfig=$(TargetConfiguration) -SkipCook -cook -pak $(PackageFlag) -stage -stagingdirectory=&quot;$(StageDirectory)\$(ProjectName)&quot; $(ArchivalFlag) -unattended -stdlog" />
                            <Tag BaseDir="$(StageDirectory)\$(ProjectName)\$(StagePlatform)" Files="..." With="#GameStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                            <Tag BaseDir="$(ProjectRoot)\Binaries\$(TargetPlatform)" Files="..." With="#GameStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="('$(TargetPlatform)' == 'IOS') or ('$(TargetPlatform)' == 'Android')" />
                        </Node>
                        <Property Name="GameStagedContent" Value="$(GameStagedContent)#GameStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);" If="!ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')" />
                    </ForEach>
                </ForEach>
            </ForEach>

        <!-- Stage and Package the Client-->
            <ForEach Name="TargetName" Values="$(ClientTargets)">
                <ForEach Name="TargetPlatform" Values="$(ClientTargetPlatforms)">
                    <ForEach Name="TargetConfiguration" Values="$(ClientConfigurations)">
                        <Node Name="Stage and Package $(ProjectName) $(TargetName) $(TargetPlatform) $(TargetConfiguration)" Requires="#ClientBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);#ClientCookedContent_$(ProjectName)_$(TargetPlatform)" Produces="#ClientStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="!ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')">
                            <Property Name="StagePlatform" Value="$(TargetPlatform)" />
                            <Property Name="StagePlatform" Value="Windows" If="'$(StagePlatform)' == 'Win64'" />
                            <Property Name="DisableCodeSigning" Value="" />
                            <Property Name="DisableCodeSigning" Value="-NoCodeSign" If="('$(TargetPlatform)' == 'Win64') or ('$(TargetPlatform)' == 'Mac') or ('$(TargetPlatform)' == 'Linux')" />
                            <Property Name="PackageFlag" Value="" />
                            <Property Name="PackageFlag" Value="-package" If="('$(TargetPlatform)' == 'IOS') or ('$(TargetPlatform)' == 'Android')" />
                            <Spawn Exe="cmd" Arguments="/C set uebp_UATMutexNoWait=1 &amp; $(EnginePath)\Build\BatchFiles\RunUAT.bat BuildCookRun -project=&quot;$(ProjectPath)&quot; -noP4 $(DisableCodeSigning) -platform=$(TargetPlatform) -clientconfig=$(TargetConfiguration) -SkipCook -cook -pak $(PackageFlag) -stage -stagingdirectory=&quot;$(StageDirectory)\$(ProjectName)&quot;" />
                            <Tag BaseDir="$(StageDirectory)\$(ProjectName)\$(StagePlatform)" Files="..." With="#ClientStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                            <Tag BaseDir="$(ProjectRoot)\Binaries\$(TargetPlatform)" Files="..." With="#ClientStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="('$(TargetPlatform)' == 'IOS') or ('$(TargetPlatform)' == 'Android')" />
                        </Node>
                        <Property Name="ClientStagedContent" Value="$(ClientStagedContent)#ClientStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);" If="!ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')" />
                    </ForEach>
                </ForEach>
            </ForEach>


        <!-- Stage and Package the Dedicated Server-->
            <ForEach Name="TargetName" Values="$(ServerTargets)">
                <ForEach Name="TargetPlatform" Values="$(ServerTargetPlatforms)">
                    <ForEach Name="TargetConfiguration" Values="$(ServerConfigurations)">
                        <Node Name="Stage and Package $(ProjectName) $(TargetName) $(TargetPlatform) $(TargetConfiguration)" Requires="#ServerBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);#ServerCookedContent_$(ProjectName)_$(TargetPlatform)" Produces="#ServerStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="!ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')">
                            <Property Name="StagePlatform" Value="$(TargetPlatform)" />
                            <Property Name="StagePlatform" Value="Windows" If="'$(StagePlatform)' == 'Win64'" />
                            <Property Name="DisableCodeSigning" Value="" />
                            <Property Name="DisableCodeSigning" Value="-NoCodeSign" If="('$(TargetPlatform)' == 'Win64') or ('$(TargetPlatform)' == 'Mac') or ('$(TargetPlatform)' == 'Linux')" />
                            <Property Name="PackageFlag" Value="" />
                            <Property Name="PackageFlag" Value="-package" If="('$(TargetPlatform)' == 'IOS') or ('$(TargetPlatform)' == 'Android')" />
                            <Spawn Exe="cmd" Arguments="/C set uebp_UvTMutexNoWait=1 &amp; $(EnginePath)\Build\BatchFiles\RunUAT.bat BuildCookRun -project=&quot;$(ProjectPath)&quot; -noP4 $(DisableCodeSigning) -dedicatedserver -noclient -serverplatform=$(TargetPlatform) -server -serverconfig=$(TargetConfiguration) -SkipCook -cook -pak $(PackageFlag) -stage -stagingdirectory=&quot;$(StageDirectory)\$(ProjectName)&quot;" />
                            <Tag BaseDir="$(StageDirectory)\$(ProjectName)\$(StagePlatform)" Files="..." With="#ServerStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                            <Tag BaseDir="$(ProjectRoot)\Binaries\$(TargetPlatform)" Files="..." With="#ServerStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="('$(TargetPlatform)' == 'IOS') or ('$(TargetPlatform)' == 'Android')" />
                        </Node>
                        <Property Name="ServerStagedContent" Value="$(ServerStagedContent)#ServerStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);" If="!ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')" />
                    </ForEach>
                </ForEach>
            </ForEach>

    </Agent>

    <!-- Targets that will be executed on a Mac machine-->
    <Agent Name="MacOS Stage and Package" Type="Mac" If="'$(ExecuteBuild)' == 'true'">

        <!-- Stage and Package the Game-->
            <ForEach Name="TargetName" Values="$(GameTargets)">
                <ForEach Name="TargetPlatform" Values="$(GameTargetPlatforms)">
                    <ForEach Name="TargetConfiguration" Values="$(GameConfigurations)">
                        <Node Name="Stage and Package $(ProjectName) $(TargetName) $(TargetPlatform) $(TargetConfiguration)" Requires="#GameBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);#GameCookedContent_$(ProjectName)_$(TargetPlatform)" Produces="#GameStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')">
                            <Property Name="StagePlatform" Value="$(TargetPlatform)" />
                            <Property Name="StagePlatform" Value="Windows" If="'$(StagePlatform)' == 'Win64'" />
                            <Property Name="DisableCodeSigning" Value="" />
                            <Property Name="DisableCodeSigning" Value="-NoCodeSign" If="('$(TargetPlatform)' == 'Win64') or ('$(TargetPlatform)' == 'Mac') or ('$(TargetPlatform)' == 'Linux')" />
                            <Property Name="PackageFlag" Value="" />
                            <Property Name="PackageFlag" Value="-package" If="('$(TargetPlatform)' == 'IOS') or ('$(TargetPlatform)' == 'Android')" />
                            <Spawn Exe="cmd" Arguments="/C $(EnginePath)\Build\BatchFiles\RunUAT.bat BuildCookRun -project=&quot;$(ProjectPath)&quot; -noP4 $(DisableCodeSigning) -platform=$(TargetPlatform) -clientconfig=$(TargetConfiguration) -SkipCook -cook -pak $(PackageFlag) -stage -stagingdirectory=&quot;$(StageDirectory)\$(ProjectName)&quot;" />
                            <Tag BaseDir="$(StageDirectory)\$(ProjectName)\$(StagePlatform)" Files="..." With="#GameStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                            <Tag BaseDir="$(ProjectRoot)\Binaries\$(TargetPlatform)" Files="..." With="#GameStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="('$(TargetPlatform)' == 'IOS') or ('$(TargetPlatform)' == 'Android')" />
                        </Node>
                        <Property Name="GameStagedContent" Value="$(GameStagedContent)#GameStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);" If="ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')" />
                    </ForEach>
                </ForEach>
            </ForEach>

        <!-- Stage and Package the Client-->
            <ForEach Name="TargetName" Values="$(ClientTargets)">
                <ForEach Name="TargetPlatform" Values="$(ClientTargetPlatforms)">
                    <ForEach Name="TargetConfiguration" Values="$(ClientConfigurations)">
                        <Node Name="Stage and Package $(ProjectName) $(TargetName) $(TargetPlatform) $(TargetConfiguration)" Requires="#ClientBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);#ClientCookedContent_$(ProjectName)_$(TargetPlatform)" Produces="#ClientStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')">
                            <Property Name="StagePlatform" Value="$(TargetPlatform)" />
                            <Property Name="StagePlatform" Value="Windows" If="'$(StagePlatform)' == 'Win64'" />
                            <Property Name="DisableCodeSigning" Value="" />
                            <Property Name="DisableCodeSigning" Value="-NoCodeSign" If="('$(TargetPlatform)' == 'Win64') or ('$(TargetPlatform)' == 'Mac') or ('$(TargetPlatform)' == 'Linux')" />
                            <Property Name="PackageFlag" Value="" />
                            <Property Name="PackageFlag" Value="-package" If="('$(TargetPlatform)' == 'IOS') or ('$(TargetPlatform)' == 'Android')" />
                            <Spawn Exe="cmd" Arguments="/C $(EnginePath)\Build\BatchFiles\RunUAT.bat BuildCookRun -project=&quot;$(ProjectPath)&quot; -noP4 $(DisableCodeSigning) -platform=$(TargetPlatform) -clientconfig=$(TargetConfiguration) -SkipCook -cook -pak $(PackageFlag) -stage -stagingdirectory=&quot;$(StageDirectory)\$(ProjectName)&quot;" />
                            <Tag BaseDir="$(StageDirectory)\$(ProjectName)\$(StagePlatform)" Files="..." With="#ClientStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                            <Tag BaseDir="$(ProjectRoot)\Binaries\$(TargetPlatform)" Files="..." With="#ClientStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="('$(TargetPlatform)' == 'IOS') or ('$(TargetPlatform)' == 'Android')" />
                        </Node>
                        <Property Name="ClientStagedContent" Value="$(ClientStagedContent)#ClientStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);" If="ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')" />
                    </ForEach>
                </ForEach>
            </ForEach>

        <!-- Stage and Package the Dedicated Server-->
            <ForEach Name="TargetName" Values="$(ServerTargets)">
                <ForEach Name="TargetPlatform" Values="$(ServerTargetPlatforms)">
                    <ForEach Name="TargetConfiguration" Values="$(ServerConfigurations)">
                        <Node Name="Stage and Package $(ProjectName) $(TargetName) $(TargetPlatform) $(TargetConfiguration)" Requires="#ServerBinaries_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);#ServerCookedContent_$(ProjectName)_$(TargetPlatform)" Produces="#ServerStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')">
                            <Property Name="StagePlatform" Value="$(TargetPlatform)" />
                            <Property Name="StagePlatform" Value="Windows" If="'$(StagePlatform)' == 'Win64'" />
                            <Property Name="DisableCodeSigning" Value="" />
                            <Property Name="DisableCodeSigning" Value="-NoCodeSign" If="('$(TargetPlatform)' == 'Win64') or ('$(TargetPlatform)' == 'Mac') or ('$(TargetPlatform)' == 'Linux')" />
                            <Property Name="PackageFlag" Value="" />
                            <Property Name="PackageFlag" Value="-package" If="('$(TargetPlatform)' == 'IOS') or ('$(TargetPlatform)' == 'Android')" />
                            <Spawn Exe="cmd" Arguments="/C $(EnginePath)\Build\BatchFiles\RunUAT.bat BuildCookRun -project=&quot;$(ProjectPath)&quot; -noP4 $(DisableCodeSigning) -dedicatedserver -noclient -serverplatform=$(TargetPlatform) -server -serverconfig=$(TargetConfiguration) -SkipCook -cook -pak $(PackageFlag) -stage -stagingdirectory=&quot;$(StageDirectory)\$(ProjectName)&quot;" />
                            <Tag BaseDir="$(StageDirectory)\$(ProjectName)\$(StagePlatform)" Files="..." With="#ServerStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" />
                            <Tag BaseDir="$(ProjectRoot)\Binaries\$(TargetPlatform)" Files="..." With="#ServerStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration)" If="('$(TargetPlatform)' == 'IOS') or ('$(TargetPlatform)' == 'Android')" />
                        </Node>
                        <Property Name="ServerStagedContent" Value="$(ServerStagedContent)#ServerStagedContent_$(ProjectName)_$(TargetName)_$(TargetPlatform)_$(TargetConfiguration);" If="ContainsItem('$(MacPlatforms)', '$(TargetPlatform)', ';')" />
                    </ForEach>
                </ForEach>
            </ForEach>

    </Agent>
   
    <!--<Agent Name="Windows Tests" Type="Win64" If="'$(ExecuteTests)' == 'true'">

        <!- Run the Editor Tests ->
        <ForEach Name="Tests" Values="$(TestsToRun)" Separator="+">
            <Property Name="TestName" Value="" />
            <Property Name="TestRequirements" Value="" />
            <ForEach Name="Test" Values="$(Tests)" Separator="~">
                <Switch>
                    <Case If="'$(TestName)' == ''">
                        <Property Name="TestName" Value="$(Test)" />
                    </Case>
                    <Default>
                        <Property Name="TestRequirements" Value="$(Test)" />
                    </Default>
                </Switch>
            </ForEach>
            <Node Name="Test $(TestName)" Requires="$(TestRequirements)" If="'$(ExecuteBuild)' == 'true'">
                <!-CMD CALL TEST ->
    </Agent>-->
    </ForEach>
    <!-- Targets that will be executed on a Windows machine -->
    <Agent Name="Windows Tag" Type="Win64">

        <!-- All Encompassing node-->
        <Node Name="Complete" Requires="$(GameStagedContent);$(ClientStagedContent);$(ServerStagedContent)">
        </Node>
    
    </Agent>

</BuildGraph>